<form [formGroup]="eventShowForm" class="container mt-4">
    <!-- General Info -->
    <div class="card mb-4 shadow-sm ">
        <div class="card-body ">
            <h4 class="card-title mb-3 text-center">Event Creation Info</h4>
            <!-- Name -->
            <div class="row">
                <div class="mb-3 w-50">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-control" formControlName="name" placeholder="Enter name"
                        [ngClass]="{'is-invalid': isInvalid('name')}" />
                    @if(isInvalid('name')){
                    <div class="invalid-feedback">
                        Name is required (min 4 characters).
                    </div>
                    }
                </div>

                <!-- Poster -->
                <div class="mb-3 w-50">
                    <label class="form-label">Poster</label>
                    <input type="file" class="form-control" (change)="handlePosterImgUpload($event,'imageurl')"
                        [ngClass]="{'is-invalid': isInvalid('imageurl')}" />
                    @if(isInvalid('imageurl')){
                    <div class="invalid-feedback">
                        Poster is required.
                    </div>
                    }
                </div>
            </div>
            <!-- Description -->
            <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control h-25" rows="3" formControlName="description"
                    placeholder="Enter description" [ngClass]="{'is-invalid': isInvalid('description')}"></textarea>
                @if(isInvalid('description')){
                <div class="invalid-feedback">
                    Description is required (min 30 characters).
                </div>
                }
            </div>

            <!--date-->
            <div class="row">



                <!--duration-->
                <div class="w-50">
                    <label class="form-label">Duration (min)</label>
                    <input type="number" class="form-control" formControlName="runTime" min="20"
                        placeholder="Enter duration" />
                    @if(eventShowForm.get('runTime')?.touched && eventShowForm.get('runTime')?.hasError('required')){
                    <div class="text-danger">
                        Duration is required.
                    </div>
                    }
                    @if(eventShowForm.get('runTime')?.touched && eventShowForm.get('runTime')?.hasError('min')){
                    <div class="text-danger">
                        Duration must be greater than 20.
                    </div>
                    }
                </div>
                <!-- Age Limit -->
                <div class="mb-3 w-50">
                    <label class="form-label">Age Limit</label>
                    <input type="number" class="form-control" formControlName="ageLimit" min="8" max="100"
                        [ngClass]="{'is-invalid': isInvalid('ageLimit')}" />
                    @if(isInvalid('ageLimit')){
                    <div class="invalid-feedback">
                        Age Limit is required (Min.8-Max.100).
                    </div>
                    }
                </div>
            </div>
        </div>
        <!-- Event Type -->
        <div class="row px-3 my-3 ">
            <div ngbDropdown class="w-50 mb-3">
                <label class="form-label">Event Type</label>
                <button class="btn btn-white border w-100 text-start" id="nameDropdown" ngbDropdownToggle>
                    {{ eventShowForm.get('eventType')?.value || 'Select Name' }}
                </button>
                <div ngbDropdownMenu aria-labelledby="nameDropdown" class="w-100">
                    @for(eventType of ['Movie','Sports','Event','Plays','Activities'];track $index){
                    <button ngbDropdownItem (click)="setEventType(eventType)">
                        {{ eventType }}
                    </button>
                    }
                </div>
                @if(eventShowForm.get('eventType')?.touched && eventShowForm.get('eventType')?.invalid){
                <div class="text-danger">
                    Event Type is required.
                </div>
                }
            </div>

            <!--city-->
            <div ngbDropdown [autoClose]="'outside'" class=" w-50 mb-3 ">
                <label class="form-label">City</label>
                <button class="btn btn-white border w-100 text-start" ngbDropdownToggle>
                    {{ city.controls.length > 0 ? eventShowForm.get('city')?.value.join(', ') : 'Select Cities' }}
                </button>
                @if(citiesArray){
                <div ngbDropdownMenu aria-labelledby="cityDropdown" class="w-100 p-2"
                    style="max-height: 200px; overflow-y: auto;">
                    @for(city of citiesArray; track $index) {
                    <div class="dropdown-item">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" [value]="city.cityName"
                                [checked]="eventShowForm.get('city')?.value.includes(city.cityName)"
                                (change)="toggleCity($event)">
                            <label class="form-check-label">
                                {{ city.cityName }}
                            </label>
                        </div>
                    </div>
                    }
                </div>
                }

            </div>
        </div>

        <!--venue name -->
        <div class="row mb-3 px-3  ">
            <div ngbDropdown [autoClose]="'outside'" class="w-50 ">
                <label class="form-label">Venue Name:</label>
                <button class="btn btn-white border w-100 text-start" ngbDropdownToggle>
                    {{ venueName.controls.length > 0 ? eventShowForm.get('venueName')?.value.join(', ') :
                    'Select Venues' }}
                </button>
                <div ngbDropdownMenu aria-labelledby="cityDropdown" class="w-100 p-2"
                    style="max-height: 200px; overflow-y: auto;">
                    <!-- onVenueNameChange() -->
                    @for(venue of venuesNameList ;track $index) {
                    <div class="dropdown-item">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input bg-white" [value]="venue?.venueName"
                                [checked]="eventShowForm.get('venueName')?.value.includes(venue.venueName)"
                                (change)="toggleVenueName($event)">
                            <label class="form-check-label">
                                {{ venue?.venueName }}
                            </label>
                        </div>
                    </div>
                    }
                </div>
            </div>
            @if(eventShowForm.get('venueName')?.touched && eventShowForm.get('venueName')?.invalid){
            <div class="text-danger">
                Venue name is required.
            </div>
            }

            @if(eventShowForm.get('eventType')?.value=='Movie'){
            <!-- Releasing On -->
            <div class="mb-3 col-4">
                <label class="form-label">Releasing On</label>
                <input type="date" class="form-control" formControlName="releasingOn" [min]="setToday()"
                    [ngClass]="{'is-invalid': isInvalid('releasingOn')}" />
                @if(isInvalid('releasingOn')){
                <div class="invalid-feedback">
                    Release date is required.
                </div>
                }
            </div>
            }

            @else if(eventShowForm.get('eventType')?.value!='Movie' && eventShowForm.get('eventType')?.value!=''){
            <div class="d-flex align-items-center justify-content-center col-4 gap-2">
                <!-- Starting On  -->
                <div class="mb-3 w-100">
                    <label class="form-label">Starting On</label>
                    <input type="date" class="form-control" formControlName="startDate" [min]="setToday()"
                        [ngClass]="{'is-invalid': isInvalid('startDate')}" />
                    @if(isInvalid('startDate')){
                    <div class="invalid-feedback">
                        Start Date is required.
                    </div>
                    }
                </div>

                <!-- Starting On  -->
                <div class="mb-3 w-100">
                    <label class="form-label">Ending On</label>
                    <input type="date" class="form-control" formControlName="endDate" [min]="setMinEndDate()"
                        [ngClass]="{'is-invalid': isInvalid('endDate')}" />
                    @if(isInvalid('endDate')){
                    <div class="invalid-feedback">
                        End Date is required.
                    </div>
                    }
                </div>

            </div>
            }
        </div>
        <!-- Content Details -->
        @if(eventShowForm.get('eventType')?.value =='Movie' && eventShowForm.get('venueName')?.value !=''){
        <div class="row my-3 ">
            <!--screen name-->
            <div class="mb-3 w-100 px-5 " formArrayName="screens">
                @for(screen of screens.controls ;track $index){
                <div class="w-100  card my-3 mx-auto  mb-1 p-3" [formGroupName]="$index">
                    <h4> Venue Name: {{screen.get('venueName')?.value}}</h4>
                    <span class="fs-5 fw-semibold  mb-2">Screen Name: {{screen.get('screenName')?.value}} </span>
                    <div formArrayName="layouts" class="mb-1 w-100">
                        <span class="fs-5 fw-semibold">Categories</span>
                        @for(layout of getLayouts(screen).controls ;track $index){
                        <div [formGroupName]="$index" class="row my-3 d-flex  w-100 mx-auto px-3">
                            <div class="d-flex align-items-center justify-content-center  gap-2 col-2">
                                <span class="my-0 fw-semibold"> Name: </span>
                                <span class="bg-white text-dark  rounded   w-75">
                                    {{layout.get('layoutName')?.value}}
                                </span>
                            </div>
                            <div class="d-flex align-items-center justify-content-center  gap-2 col-2">
                                <span class="my-0 fw-semibold"> Rows: </span>
                                <span class="bg-white text-dark  rounded px-3 py-2 w-75 my-1 ">
                                    {{layout.get('rows')?.value}}
                                </span>
                            </div>
                            <div class="d-flex align-items-center justify-content-center  gap-2 col-2">
                                <span class="my-0 fw-semibold"> Cols: </span>
                                <span class="bg-white text-dark  rounded px-3 py-2 w-75 my-1">
                                    {{layout.get('cols')?.value}}
                                </span>
                            </div>
                            <div class="d-flex align-items-center justify-content-center  gap-2 col-2">
                                <span class="my-0 fw-semibold"> Total Seats: </span>
                                <span class="bg-white text-dark  rounded px-3 py-2 w-75 my-1">
                                    {{+layout.get('cols')?.value * +getRows(layout)}}
                                </span>
                            </div>
                            <div class="d-flex align-items-center justify-content-center  gap-2 col-2">
                                <span class="my-0 fw-semibold"> Price: </span>
                                <input type="number" formControlName="price" min="0"
                                    class="form-control px-3 py-2 w-75 my-1">
                                @if(layout.get('price')?.touched && layout.get('price')?.invalid){
                                <div class="text-danger">
                                    Price is required.
                                </div>
                                }
                            </div>
                        </div>
                        }
                    </div>
                    <div class="col-3  d-flex align-items-center ">
                        <span class="fs-5 fw-semibold  w-50">Shows</span>
                        <button class="btn btn-outline-success w-50" (click)="addShow(screen)">Add</button>
                    </div>
                    <!-- shows array -->
                    <div class="" formArrayName="shows">
                        @for(show of getShows(screen).controls ;track $index){
                        <!-- one particualr show =  date & [times] -->
                        <div [formGroupName]="$index" class="row my-3 d-flex card gap-2 py-3 mx-auto  w-100 ">
                            <!-- date control -->
                            <div class="d-flex align-items-center fs-5 justify-content-start gap-0 w-100 ">
                                <span class="my-0 fw-semibold me-2 p-0   "> Date: </span>
                                <input type="date" class="form-control me-3 w-25" formControlName="date"
                                    [min]="validateShowStartDate($index)">
                                <button class="btn btn-outline-primary col-1 ms-auto" (click)="addShowTime(show)">Add
                                </button>
                                <button class="btn btn-outline-danger ms-3" [disabled]="$index==0"
                                    (click)="removeShow(screen,$index)">Remove</button>
                            </div>
                            <!-- start-time array -->
                            <div class=" d-flex align-items-center justify-content-start gap-4 w-100 flex-wrap"
                                formArrayName="startTime">
                                @for(time of getStartTime(show).controls ;track $index){
                                <div class="d-flex align-items-center justify-content-center  gap-2 w-25 ">
                                    <span class="my-0 fw-semibold w-100 fs-6 p-0 "> Start Time: </span>
                                    <select class="form-select" [formControlName]="$index">
                                        <option value="" disabled selected>Select</option>
                                        @for(slot of ['11:00','13:00','15:00','18:00',];track $index){
                                        <option value={{slot}}>
                                            {{slot}}
                                        </option>
                                        }
                                    </select>
                                    <button class="btn btn-close" (click)="removeShowTime(show, $index)"></button>
                                </div>
                                }
                            </div>
                        </div>
                        }
                    </div>
                </div>
                }
            </div>
        </div>
        }
        <!-- event type != movie -->
        @if(eventShowForm.get('shows')?.value && eventShowForm.get('eventType')?.value != ''){
        <div class="d-flex align-items-center gap-4 my-3 px-3 w-auto">
            <h4>Shows</h4>
            <button class="btn btn-outline-success " (click)="addEventShow()">Add Show</button>
        </div>
        <!-- shows array -->
        <div class=" w-100" formArrayName="shows">
            @for(show of shows.controls ;track $index){
            <!-- one particualr show =  date & [times] -->
            <div [formGroupName]="$index" class="row my-3 d-flex card gap-2 py-3  w-75 mx-auto ">
                <!-- date control -->
                <div class="d-flex align-items-center fs-5 justify-content-start gap-0 w-100 ">
                    <span class="my-0 fw-semibold me-2 p-0   "> Date: </span>
                    <input type="date" class="form-control me-3 w-25" [min]="validateShowStartDate($index)"
                        [max]="validateShowEndDate()" formControlName="date">
                    <button class="btn btn-outline-primary col-1 ms-auto" (click)="addShowTime(show)">Add </button>
                    <button class="btn btn-outline-danger ms-3" [disabled]="$index==0"
                        (click)="removeEventShow($index)">Remove</button>
                </div>
                <!-- start-time array -->
                <div class=" d-flex align-items-center justify-content-start gap-4 w-100 flex-wrap"
                    formArrayName="startTime">
                    @for(time of getStartTime(show).controls ;track $index){
                    <div class="d-flex align-items-center justify-content-center  gap-2 w-25 ">
                        <span class="my-0 fw-semibold w-100 fs-6 p-0 "> Start Time: </span>

                        <select class="form-select" [formControlName]="$index">
                            <option value="" disabled selected>Select</option>
                            @for(slot of ['11:00','13:00','15:00','18:00'];track $index){
                            <option value={{slot}}>
                                {{slot}}
                            </option>
                            }
                        </select>
                        <button class="btn btn-close" [disabled]="$index==0"
                            (click)="removeShowTime(show, $index)"></button>
                    </div>
                    }
                </div>
            </div>
            }
        </div>
        }
        @if(eventShowForm.get('price') && eventShowForm.get('eventType')?.value != ''){
        <div class="my-2 row d-flex align-items-center p-3 px-4 ">
            <div class="w-75 d-flex align-items-center py-3 gap-5">
                <h4>Price : ‚Çπ</h4>
                <input type="number" formControlName="price" min="0" class="form-control px-3 w-25 ms-1">
            </div>
        </div>
        }
    </div>
    <!-- Arrays Section -->
    @if(eventShowForm.get('eventType')?.value != ''){
    <div class="card border mb-4 shadow-sm p-3">
        <!-- Languages -->
        @if(eventShowForm.get('languages')){
        <div class="mb-3 ">
            <h5 class="form-label">‚óè Languages</h5>
            <div class="d-flex flex-wrap">
                @for(lang of languagesArray; track $index) {
                <div class="form-check w-25">
                    <input type="checkbox" class="form-check-input" (change)="handleInputBoxChange($event,'languages')"
                        [value]="lang.languageId" [ngClass]="{'is-invalid': isInvalid('languages')}">
                    <label class="form-check-label">{{lang.languageName}}</label>
                </div>
                }
            </div>
            @if(isInvalid('languages')){
            <div class="invalid-feedback">
                At least one language is required.
            </div>
            }
        </div>
        }
        <!-- Genres -->
        @if(eventShowForm.get('genres')){
        <div class="mb-3 ">
            <h5 class="form-label">‚óè Genres</h5>
            <div class="d-flex flex-wrap">
                @for(genre of genresArray; track $index) {
                <div class="form-check w-25">
                    <input type="checkbox" class="form-check-input" (change)="handleInputBoxChange($event,'genres')"
                        [value]="genre.genresId" [ngClass]="{'is-invalid': isInvalid('genres')}">
                    <label class="form-check-label">{{genre.genresName}}</label>
                </div>
                }
            </div>
            @if(isInvalid('genres')){
            <div class="invalid-feedback">
                At least one genre is required.
            </div>
            }
        </div>
        }
        <!-- Formats -->
        @if(eventShowForm.get('format')){
        <div class="mb-3 ">
            <h5 class="form-label">‚óè Formats</h5>
            <div class="d-flex flex-wrap">
                @for(format of formatsArray; track $index) {
                <div class="form-check w-25">
                    <input type="checkbox" class="form-check-input" (change)="handleInputBoxChange($event,'format')"
                        [value]="format.formatId" [ngClass]="{'is-invalid': isInvalid('format')}">
                    <label class="form-check-label">{{format.formatName}}</label>
                </div>
                }
            </div>
            @if(isInvalid('format')){
            <div class="invalid-feedback">
                At least one format is required.
            </div>
            }
        </div>
        }
        <!-- Tags -->
        @if(eventShowForm.get('tag')){
        <div class="mb-3 ">
            <h5 class="form-label">‚óè Tags</h5>
            <div class="d-flex flex-wrap">
                @for(tag of tagsArray; track $index) {
                <div class="form-check w-25">
                    <input type="checkbox" class="form-check-input" [value]="tag.tagId"
                        (change)="handleInputBoxChange($event,'tag')" [value]="tag.tagId"
                        [ngClass]="{'is-invalid': isInvalid('tag')}">
                    <label class="form-check-label">{{tag.tagName}}</label>
                </div>
                }
            </div>
            @if(isInvalid('tag')){
            <div class="invalid-feedback">
                At least one tag is required.
            </div>
            }
        </div>
        }
        <!-- Categories -->
        @if(eventShowForm.get('categories')){
        <div class="mb-3 ">
            <h5 class="form-label">‚óè Categories</h5>
            <div class="d-flex flex-wrap">
                @for(category of categoriesArray; track $index) {
                <div class="form-check w-25">
                    <input type="checkbox" class="form-check-input" (change)="handleInputBoxChange($event,'categories')"
                        [value]="category.categoryId" [ngClass]="{'is-invalid': isInvalid('categories')}">
                    <label class="form-check-label">{{category.categoryName}}</label>
                </div>
                }
            </div>
            @if(isInvalid('categories')){
            <div class="invalid-feedback">
                At least one category is required.
            </div>
            }
        </div>
        }
        <!-- More Filters -->
        @if(eventShowForm.get('moreFilters')){
        <div class="mb-3 ">
            <h5 class="form-label">‚óè More Filters</h5>
            <div class="d-flex flex-wrap">
                @for(moreFilter of moreFilters; track $index) {
                <div class="form-check w-25">
                    <input type="checkbox" class="form-check-input"
                        (change)="handleInputBoxChange($event,'moreFilters')" [value]="moreFilter.moreFilterId"
                        [ngClass]="{'is-invalid': isInvalid('moreFilters')}">
                    <label class="form-check-label">{{moreFilter.moreFilterName}}</label>
                </div>
                }
            </div>
            @if(isInvalid('moreFilters')){
            <div class="invalid-feedback">
                At least one filter is required.
            </div>
            }
        </div>
        }
    </div>
    }
    <!-- Cast -->
    @if(eventShowForm.get('eventType')?.value == 'Movie' || eventShowForm.get('eventType')?.value == 'Plays' ||
    eventShowForm.get('eventType')?.value == 'Activities'|| eventShowForm.get('eventType')?.value == 'Event'){
    <div class="card mb-4 shadow-sm">
        <div class="card-body" formArrayName="cast">
            <div class="d-flex mb-3 justify-content-start align-items-center gap-4">
                <h5 class="card-title mb-0">üé≠ Cast</h5>
                <button class="btn btn-outline-primary btn-sm" type="button" (click)="addCast()">Add Cast</button>
            </div>
            @for(c of castControls.controls;track $index ){
            <div formGroupName="{{$index}}" class="row mb-2">
                <div class="col">
                    <input class="form-control" placeholder="Actor Name" formControlName="actorName"
                        [ngClass]="{'is-invalid': c.get('actorName')?.invalid && (c.get('actorName')?.touched || c.get('actorName')?.dirty)}" />
                    @if(c.get('actorName')?.invalid && (c.get('actorName')?.touched || c.get('actorName')?.dirty)){
                    <div class="invalid-feedback">
                        Actor name is required.
                    </div>
                    }
                </div>
                <div class="col">
                    <input type="file" class="form-control" (change)="handleImageUpload($event,'cast',$index)"
                        [ngClass]="{'is-invalid': c.get('castImg')?.invalid && (c.get('castImg')?.touched || c.get('castImg')?.dirty)}" />
                    @if(c.get('castImg')?.invalid && (c.get('castImg')?.touched || c.get('castImg')?.dirty)){
                    <div class="invalid-feedback">
                        Cast image is required.
                    </div>
                    }
                </div>
                <div class="col-auto">
                    <button class="btn btn-outline-danger" type="button" [disabled]="$index==0"
                        (click)="castControls.removeAt($index)">‚úï</button>
                </div>

            </div>
            }
        </div>
    </div>
    <!-- Crew -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body" formArrayName="crew">
            <div class="d-flex mb-3 justify-content-start align-items-center gap-4">
                <h5 class="card-title">üé¨ Crew</h5>
                <button class="btn btn-outline-primary btn-sm" type="button" (click)="addCrew()">Add Crew</button>
            </div>
            @for(m of crewControls.controls;track $index){
            <div formGroupName="{{$index}}" class="row mb-2">
                <div class="col">
                    <input class="form-control" placeholder="Member Name" formControlName="memberName"
                        [ngClass]="{'is-invalid': m.get('memberName')?.invalid && (m.get('memberName')?.touched || m.get('memberName')?.dirty)}" />
                    @if(m.get('memberName')?.invalid && (m.get('memberName')?.touched || m.get('memberName')?.dirty)){
                    <div class="invalid-feedback">
                        Member name is required.
                    </div>
                    }
                </div>
                <div class="col">
                    <input type="file" class="form-control" (change)="handleImageUpload($event,'crew',$index)"
                        [ngClass]="{'is-invalid': m.get('crewImg')?.invalid && (m.get('crewImg')?.touched || m.get('crewImg')?.dirty)}" />
                    @if(m.get('crewImg')?.invalid && (m.get('crewImg')?.touched || m.get('crewImg')?.dirty)){
                    <div class="invalid-feedback">
                        Crew image is required.
                    </div>
                    }
                </div>
                <div class="col-auto">
                    <button class="btn btn-outline-danger" type="button" [disabled]="$index==0"
                        (click)="crewControls.removeAt($index)">‚úï</button>
                </div>
            </div>
            }
        </div>
    </div>}
    <!-- Submit -->
    <div class="text-end mb-3">
        <button class="btn btn-primary px-4" type="submit" (click)="onShowFormSubmit()">Submit</button>
    </div>
</form>